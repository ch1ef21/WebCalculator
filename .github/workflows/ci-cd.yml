name: Web Calculator CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: src/WebCalculator/WebCalculator.csproj
  TEST_PATH: tests/WebCalculator.Tests/WebCalculator.Tests.csproj

jobs:
  build-test-package:
    name: Сборка, тесты, публикация и пакет
    runs-on: ubuntu-latest
    needs: [setup]

    steps:
      - name: Загружаем код
        uses: actions/checkout@v4

      - name: Устанавливаем .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Восстанавливаем зависимости
        run: dotnet restore ${{ env.PROJECT_PATH }}

      - name: Собираем проект
        run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore

      - name: Запуск юнит-тестов
        run: dotnet test ${{ env.TEST_PATH }} --no-build --configuration Release --verbosity normal --logger trx --collect:"XPlat Code Coverage"

      - name: Сохраняем результаты тестов
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/TestResults/
            **/coverage.*

      - name: Публикация приложения
        run: dotnet publish ${{ env.PROJECT_PATH }} --configuration Release --no-restore --output ./publish

      - name: Архивируем приложение
        run: |
          zip -r web-calculator-v${{ github.run_number }}.zip ./publish/*
          echo "WebCalculator-v${{ github.run_number }}.zip создан!"

      - name: Сохраняем релизный пакет
        uses: actions/upload-artifact@v4
        with:
          name: web-calculator-v${{ github.run_number }}.zip
          path: web-calculator-v${{ github.run_number }}.zip
          retention-days: 30

      - name: Финальный отчёт
        run: |
          echo "========================================"
          echo " CI/CD ПАЙПЛАЙН УСПЕШНО ЗАВЕРШЁН! "
          echo "========================================"
          echo " Выполненные этапы:"
          echo "   Подготовка окружения"
          echo "   Сборка веб-приложения"
          echo "   Запуск всех тестов"
          echo "   Создание релизного пакета"
          echo " "
          echo " СОЗДАННЫЕ АРТЕФАКТЫ:"
          echo "   • web-calculator-app — собранное приложение"
          echo "   • test-results — результаты тестирования"
          echo "   • web-calculator-v${{ github.run_number }}.zip — релизный пакет"
          echo " "
          echo " Время: $(date)"
          echo "========================================"